generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Customer {
  id                String             @id @default(uuid()) @db.Uuid
  name              String
  created_at        DateTime           @default(now())
  updated_at        DateTime           @updatedAt
  projects          Project[]
  tickets           Ticket[]
  ticket_comments   TicketComment[]
  ticket_attachments TicketAttachment[]
  audit_logs        AuditLog[]
}

model Project {
  id         String   @id @default(uuid()) @db.Uuid
  customer_id String   @db.Uuid
  name       String
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  customer   Customer @relation(fields: [customer_id], references: [id], onDelete: Cascade)
  tickets    Ticket[]

  @@index([customer_id])
}

model Ticket {
  id                 String             @id @default(uuid()) @db.Uuid
  customer_id        String             @db.Uuid
  project_id         String             @db.Uuid
  type               String
  status             String
  title              String
  description        String
  assignee_user_id   String?
  created_by_user_id String?
  created_at         DateTime           @default(now())
  updated_at         DateTime           @updatedAt
  customer           Customer           @relation(fields: [customer_id], references: [id], onDelete: Cascade)
  project            Project            @relation(fields: [project_id], references: [id], onDelete: Cascade)
  comments           TicketComment[]
  attachments        TicketAttachment[]

  @@index([customer_id, status, updated_at])
  @@index([customer_id, status, assignee_user_id])
  @@index([customer_id, project_id])
}

model TicketComment {
  id             String   @id @default(uuid()) @db.Uuid
  ticket_id      String   @db.Uuid
  customer_id    String   @db.Uuid
  author_user_id String
  body           String
  created_at     DateTime @default(now())
  ticket         Ticket   @relation(fields: [ticket_id], references: [id], onDelete: Cascade)
  customer       Customer @relation(fields: [customer_id], references: [id], onDelete: Cascade)

  @@index([ticket_id])
  @@index([customer_id])
}

model TicketAttachment {
  id                  String   @id @default(uuid()) @db.Uuid
  ticket_id           String   @db.Uuid
  customer_id         String   @db.Uuid
  filename            String
  mime                String
  size_bytes          Int
  object_key          String
  uploaded_by_user_id String
  created_at          DateTime @default(now())
  ticket              Ticket   @relation(fields: [ticket_id], references: [id], onDelete: Cascade)
  customer            Customer @relation(fields: [customer_id], references: [id], onDelete: Cascade)

  @@index([ticket_id])
  @@index([customer_id])
}

model AuditLog {
  id            String    @id @default(uuid()) @db.Uuid
  customer_id   String?   @db.Uuid
  entity_type   String
  entity_id     String
  action        String
  actor_user_id String?
  actor_role    String?
  meta_json     Json
  created_at    DateTime  @default(now())
  customer      Customer? @relation(fields: [customer_id], references: [id], onDelete: SetNull)

  @@index([customer_id, created_at])
  @@index([entity_type, entity_id, created_at])
}
